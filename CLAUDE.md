# Claude Code Guidelines for olimar-gh-app

This document provides guidelines for maintaining and developing this GitHub App webhook server project.

## Project Overview

This is a GitHub App webhook server built with Express and Octokit that listens for GitHub events and interacts with the GitHub API.

**Tech Stack:**
- TypeScript (strict mode enabled)
- Node.js with ES modules (`"type": "module"` in package.json)
- Express for webhook server
- Octokit for GitHub API interactions
- pnpm for package management (v9.0.0)

## Development Workflow

### Build and Run Commands

```bash
# Install dependencies
pnpm install

# Build the project (runs TypeScript compiler)
pnpm run build

# Run in development mode (uses tsx for hot reloading)
pnpm run dev

# Run production build
pnpm start

# Watch mode for development
pnpm run watch
```

### Before Making Changes

1. Always run `pnpm install` if `node_modules` is missing
2. Run `pnpm run build` to check for TypeScript errors before making changes
3. After making changes, run `pnpm run build` to verify no new errors were introduced

## Code Style and Standards

### TypeScript Error Handling

This project uses strict TypeScript settings. When catching errors, always properly type them:

**Correct:**
```typescript
try {
  // code
} catch (error) {
  if (error && typeof error === 'object' && 'response' in error) {
    const err = error as { response?: { status: number; data: { message: string } } };
    if (err.response) {
      console.error(`Error! Status: ${err.response.status}. Message: ${err.response.data.message}`);
    }
  }
  console.error(error);
}
```

**Incorrect (will fail TypeScript compilation):**
```typescript
try {
  // code
} catch (error) {
  if (error.response) {  // ❌ TS18046: 'error' is of type 'unknown'
    console.error(`Error! Status: ${error.response.status}`);
  }
}
```

### Webhook Event Handlers

Webhook handlers are registered in `src/webhooks.ts` using the `registerWebhookHandlers()` function.

**Pattern for webhook handlers:**
```typescript
app.webhooks.on('event_name', async ({ octokit, payload }) => {
  const repo = payload.repository.name;
  const owner = payload.repository.owner?.login;

  if (!owner) {
    console.error('No repository owner found in payload');
    return;
  }

  // Your handler logic here

  try {
    // Use octokit to interact with GitHub API
    const { data } = await octokit.request('GET /repos/{owner}/{repo}/...', {
      owner,
      repo,
      headers: {
        'x-github-api-version': '2022-11-28',
      },
    });
  } catch (error) {
    // Use proper error handling pattern (see above)
  }
});
```

### Octokit API Requests

Always include the API version header:
```typescript
await octokit.request('GET /repos/{owner}/{repo}/actions/workflows', {
  owner,
  repo,
  headers: {
    'x-github-api-version': '2022-11-28',
  },
});
```

## Project Structure

```
olimar-gh-app/
├── src/
│   ├── index.ts          # Main entry point, sets up Express server
│   └── webhooks.ts       # Webhook event handlers registration
├── dist/                 # Compiled JavaScript output (generated by tsc)
├── package.json
├── tsconfig.json
├── .env                  # Environment variables (not committed)
└── CLAUDE.md            # This file
```

## Environment Variables

Required environment variables (stored in `.env`):
- `APP_ID` - GitHub App ID (numeric value)
- `WEBHOOK_SECRET` - Webhook secret for verifying GitHub signatures
- `PRIVATE_KEY` (recommended) - GitHub App private key directly as a string (PEM format)
- `PRIVATE_KEY_PATH` (fallback) - Path to the private key file (e.g., `./private-key.pem`)
  - Note: Only one of `PRIVATE_KEY` or `PRIVATE_KEY_PATH` is required. `PRIVATE_KEY` takes precedence.
- `PORT` - Server port (optional, defaults to 3000)
- `GITHUB_OWNER` - GitHub username/org (optional)
- `GITHUB_REPO` - Repository name (optional)

## Common Tasks

### Adding a New Webhook Event Handler

1. Open `src/webhooks.ts`
2. Add a new event handler inside `registerWebhookHandlers()`:
   ```typescript
   app.webhooks.on('event_name', async ({ octokit, payload }) => {
     // handler implementation
   });
   ```
3. Run `pnpm run build` to verify TypeScript compilation
4. Test the webhook handler

### Modifying Existing Handlers

1. Locate the handler in `src/webhooks.ts`
2. Make your changes
3. Ensure proper error handling with TypeScript type checking
4. Run `pnpm run build` to verify
5. Test the changes

### Debugging

- Use `console.log()` for debugging output
- For payload inspection: `console.log(JSON.stringify(payload, null, 2))`
- Check the compiled output in `dist/` if needed
- Run in dev mode with `pnpm run dev` for faster iteration

## Testing Webhooks Locally

1. Use a tool like `ngrok` to expose your local server
2. Configure the GitHub App webhook URL to point to your ngrok URL
3. Run `pnpm run dev` to start the development server
4. Trigger events in GitHub to test webhook handling

## Git Workflow

- Main branch: `main`
- Always ensure `pnpm run build` passes before committing
- Do not commit `node_modules/` or `dist/` directories
- Do not commit `.env` file (contains secrets)

## Troubleshooting

### TypeScript Compilation Errors

- Always fix TypeScript errors before proceeding
- Common issue: `error is of type 'unknown'` - use proper type checking pattern (see above)
- Run `pnpm run build` frequently to catch errors early

### Missing Dependencies

If you see "node_modules missing" error:
```bash
pnpm install
```

### Package Manager Issues

This project uses pnpm v9.0.0 (specified in `packageManager` field). Ensure you're using pnpm, not npm or yarn.

## Key Files to Reference

- `src/webhooks.ts` - All webhook event handlers
- `src/index.ts` - Server setup and initialization
- `package.json` - Dependencies and scripts
- `tsconfig.json` - TypeScript configuration

## Maintenance Checklist

When making changes:
- [ ] Run `pnpm install` if dependencies changed
- [ ] Run `pnpm run build` to check for errors
- [ ] Use proper TypeScript error handling patterns
- [ ] Include API version headers in Octokit requests
- [ ] Test webhook handlers if modified
- [ ] Verify build passes before committing
